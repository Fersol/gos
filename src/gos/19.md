# 19. Пасивные и активные сетевые атаки (снифинг, спуфинг, MITM, имперсонация).

## Типичная атака

Стадия 1: Внешняя разведка

Стадия 2: Внутренняя разведка

Стадия 3: Атака

Стадия 4: Скрытие следов

Стадия 5: Получение прибыли

## Пассивные атаки

### Прослушивание (снифинг)

Перехват трафика может осуществляться:

- обычным «прослушиванием» сетевого интерфейса. Метод эффективен при использовании в сегменте концентраторов вместо коммутаторов, в противном случае данный метод малоэффективен, поскольку на снифер попадают лишь отдельные кадры; 
- подключением снифера в разрыв канала; 
- ответвлением (программным или аппаратным) трафика и направлением его копии на снифер; 
- через атаку на канальном или сетевом уровне, приводящую к перенаправлению трафика жертвы или всего трафика сегмента на снифер с последующим возвращением трафика в надлежащий адрес.

#### Противодействие

Ограничить область прослушивания в сети Ethernet можно разбиением сети на сегменты с помощью коммутаторов. В этом случае злоумышленник, не прибегая к активным действиям, может перехватить только кадры, получаемые или отправляемые узлами сегмента, к которому он подключен.

Простое прослушивание также не позволяет злоумышленнику модифицировать передаваемые между двумя другими узлами данные. Для решения этих задач злоумышленник должен перейти к активным действиям, чтобы внедрить себя в тракт передачи данных в качестве промежуточного узла.

**Единственным надежным способом борьбы с прослушиванием сегмента Ethernet является шифрование данных.**

Еще в слайдах описан метод AntiSniff — метод выявления пакетных сниферов основанный на предположении, что программа прослушивания на хосте злоумышленника выполняет обратные DNS-преобразования для IP-адресов подслушанных датаграмм, но это как мне кажется смешно. Однако у AntiSniff есть интересный метод выявление нод в монитор моде, посылом шквала сообщений с несуществующими в текущем сегменте Mac-адресами.

### Сканирование сети

Сканирование сети имеет своей целью выявление активных компьютеров сети. Почему то в этом пункте перечислены только ping и traceroute (и внезапно DNS).

### Сканирование TCP портов

> Мне правда нужно про это писать?

Сканируем TCP порты через хэндшейк.

1.Методы открытого сканирования: непосредственный инициатор однозначно определяется объектом сканирования по IP-адресу запросов.

2.Методы "невидимого" анонимного сканирования. Непосредственный инициатор не определяется объектом сканирования (однозначно определяется только "промежуточный" источник сканирующих запросов), таким образом, гарантируется анонимность инициатора сканирования.

Есть более хитрые способы чем ломиться с хэндшейком.

Сканирование TCP FIN — в этом методе на сканируемый порт посылается сегмент с установленным битом FIN. Хост должен ответить RST-сегментом, если FIN-сегмент адресован закрытому порту.

Сканирование с использованием IP-фрагментации — не является само по себе новым видом сканирования. Данный метод предназначен для усложнения задачи обнаружения факта сканирования и может применяться совместно с упомянутыми ранее методами. Суть его состоит в разбиении TCP SYN- или TCP FIN-зaпpoca на несколько маленьких IP-фрагментов (минимальный размер поля данных в IP-фрагменте 8 байт, следовательно, TCP SYN-запрос, имеющий минимальный размер 20 байт, можно разбить на три фрагмента). Первый фрагмент не содержит флагов, на основании, которых данные пакеты могут быть заблокированы. Тем не менее, если межсетевой экран выполняет дефрагментацию пакетов, то данный метод является неэффективным.

### UDP сканирование

Сканирование UDP-сервисов представляет собой достаточно сложную процедуру. Это связано с тем, что протокол UDP является протоколом без установления соединения, а, следовательно, отсутствуют предварительные шаги по созданию виртуального канала.

Для выполнения сканирования UDP-портов можно воспользоваться тем фактом, что большинство хостов в ответ на получение пакет, направленного на закрытый UDP-порт отвечают ICMP пакетом ICMP_PORT_UNREACH. Таким образом, можно обнаружить закрытые порты.

Исключив закрытые порты можно получить список открытых портов. Данный вид сканирования является медленным, так как в соответствии с RFC 1812 хост может значительно ограничить количество ответов содержащих ICMP-сообщения об ошибках.

### Другие сканирования

По различному поведению в разных сценариях можно выяснить и ОС системы и версию ПО и тд.

## Активные атаки

Спуфинг — ситуация, в которой один человек или программа успешно маскируется под другую путём фальсификации данных и позволяет получить незаконные преимущества.

### Ложный ARP-сервер

Это называется ARP **спуфинг** — отвечаем на arp запросы, что хост или маршрутизатор это мы, получаем пакеты.

### Ложный DNS-сервер

#### Перехват DNS запроса

Для реализации атаки путем перехвата DNS-запроса злоумышленнику необходимо перехватить запрос, извлечь из него номер UDP-порта хоста отправителя, двухбайтовое значение ID-идентификатора DNS-запроса и искомое имя, а затем послать ложный DNS-ответ на извлеченный из DNS-запроса UDP порт, где в качестве искомого IP-адреса указать настоящий IP-адрес ложного DNS-сервера. Такой вариант атаки в дальнейшем позволит полностью перехватить трафик между атакуемым хостом и сервером и активно воздействовать на него. Необходимым условием осуществления данного варианта атаки является возможность перехвата DNS-запроса, а это возможно только в том случае, если атакующий находится, либо на пути следования запроса к DNS-серверу, либо в одном сегменте с DNS-сервером.

#### Направленный шторм ложных DNS-ответов

Другой вариант осуществления удаленной DNS-атаки - внедрение в сеть Internet ложного сервера путем создания направленного шторма ложных DNS-ответов на атакуемый хост. В этом случае злоумышленник осуществляет постоянную передачу на атакуемый хост заранее подготовленного ложного DNS-ответа от имени настоящего DNS-сервера без предыдущего приема DNS-запроса.

Но IP-адрес отправителя ответа должен совпадать с IP-адресом DNSсервера, а имя в DNS-ответе - с именем в DNS-запросе; кроме того, DNS-ответ следует направить на тот же UDP-порт, с которого было послано сообщение (в данном случае это первая проблема для взломщика), и поле идентификатора запроса (ID) в заголовке DNS-ответа должно содержать то же значение, что и в переданном запросе (а это вторая проблема).

Таким образом, реализация данной удаленной атаки, использующей пробелы в безопасности службы DNS, позволяет из любой точки сети Internet нарушить маршрутизацию между двумя заданными объектами (хостами). Такая атака осуществляется межсегментно по отношению к цели атаки и угрожает безопасности любого хоста Internet, использующего обычную службу DNS.

### Имперсонация

Предположим, что узел А обменивается IP-датаграммами с узлом В, при этом узлы идентифицируют друг друга по IP-адресам, указываемым в датаграммах. Предположим далее, что узел В имеет особые привилегии при взаимодействии с А: то есть А предоставляет В некоторый сервис, недоступный для других хостов Internet. Злоумышленник на узле Х, желающий получить такой сервис, должен имитировать узел В — такие действия называются имперсонацией узла В узлом Х.

Пусть узел находится в сети, не имеющей никакого отношения к узлам А и В и не лежащей между ними (А и В могут находиться как в одной, так и в разных сетях). Легко видеть, что имперсонация UDP-сообщений без обратной связи является тривиальной - злоумышленник должен только сфабриковать датаграмму, адресованную от узла В узлу А, и отправить ее по назначению.

Схема атаки с имперсонацией TCP-соединения без обратной связи

1. Злоумышленник выводит из строя узел В.
2. Злоумышленник делает несколько пробных попыток установить соединения с узлом А с целью получить от А последовательность значений ISN(A). Сразу после поступления SYN-сегмента от А злоумышленник разрывает наполовину установленное соединение посылкой сегмента с флагом RST. Проанализировав полученные значения ISN(A), злоумышленник определяет закон формирования этих значений.
3. Злоумышленник отправляет в А SYN сегмент от имени В.
4. Узел А отвечает узлу В свои SYN сегментом, подтверждающим получение SYN-сегмента от В, и указывает значение ISN(A) для этого соединения. Злоумышленник не видит этого сегмента.
5. На основе ранее полученных данных злоумышленник предсказывает значение ISN(A) и отправляет в А сегмент от имени В, содержащий подтверждение ISN(A)+1 и данные для прикладного процесса. Получив этот сегмент, узел А считает соединение с В установленным и передает поступившие данные прикладному процессу. Цель атаки достигнута. Данные могут быть, например, командой, которую узел А выполняет, потому что она поступила от доверенного узла В.

### MITM

Про него в слайдах не говорится, но когда мы пропускаем через себя чужой трафик и выступай своего рода проксей (тайно для участников) это и есть MITM. Чтобы всех этих проблем не было используйте TLS современных версий с рекомендациями от Mozilla и не забывайте обновлять ОС, Nginx и openssl).